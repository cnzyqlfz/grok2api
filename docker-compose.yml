services:
  grok2api:
    build:
      context: .
      dockerfile: Dockerfile
    image: grok2api:local
    container_name: grok2api
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - grok_data:/app/data
      - ./logs:/app/logs
    environment:
      # ===== 存储模式 =====
      # 支持 file, mysql 或 redis
      - STORAGE_MODE=file

      # ===== 数据库 =====
      # 仅在 STORAGE_MODE=mysql 或 redis 时需要
      # - DATABASE_URL=mysql://user:password@host:3306/grok2api
      # MySQL: mysql://user:password@host:port/database
      # Redis: redis://host:port/db 或 redis://user:password@host:port/db

      # ===== Worker 数量 =====
      # 默认 1；多进程建议使用 MySQL/Redis 存储
      - WORKERS=1

    # 健康检查（容器内访问）
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health', timeout=3)"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

volumes:
  grok_data:
